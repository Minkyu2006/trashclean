<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate ="~{layout/default}">

<head>

	<script type="text/javascript">
		var map; // 멥
		var marker; // 마커
		var polyline; // 맵에 길찾기그려주는 라인

		$(function() {

			$("#dateFrom").datepicker({});

			$("#removehour").removeClass(" active");
			$("#starthour").addClass(" active");
			$("#intervaltime").val("3");

			deviceListView(1);
			LocationSetting("");

			$("#btnSearch").on('click',function(){
				deviceListView(1);
			});

			$("#mapChart").on('click',function(){
				refleshMapChart();
			});
			$("#circleChart").on('click',function(){
				$("#pieChartLoading").show();
				refleshCircleChart();
			});
			$("#barChart").on('click',function(){
				$("#barChartLoading").show();
				refleshBarChart();
			});

			// 자동 새로고침 유저 정보의따라 바뀌기 작업
			if($('#refleshCheck').val()==="1"){
				$("#monitoring").prop('checked',true);
			}else{
				$("#monitoring").prop('checked',false);
			}

			if($('#refleshCount').val()==="1"){
				$("#tensec").prop('checked',true);
			}else if($('#refleshCount').val()==="2"){
				$("#onemin").prop('checked',true);
			}else if($('#refleshCount').val()==="3"){
				$("#twomin").prop('checked',true);
			}else if($('#refleshCount').val()==="4"){
				$("#fivemin").prop('checked',true);
			}else if($('#refleshCount').val()==="5"){
				$("#ftmin").prop('checked',true);
			}else{
				$("#tensec").prop('checked',true);
			}
			refleshAutomatic();

			$("#closeMasterfold").on('click',function(){
				$("#mapfold").toggleClass(" fold");
				$("#circlefold").toggleClass(" fold");
				$("#levelfold").toggleClass(" fold");
				refleshBarChart();
				refleshCircleChart();
				$("#closeMasterfold").hide();
				$("#openMasterfold").show();
			});

			$("#openMasterfold").on('click',function(){
				$("#mapfold").toggleClass(" fold");
				$("#circlefold").toggleClass(" fold");
				$("#levelfold").toggleClass(" fold");
				refleshBarChart();
				refleshCircleChart();
				$("#openMasterfold").hide();
				$("#closeMasterfold").show();
			});

			$("#refreshMaster").on('click',function() {
				$("#mapChartLoading").show();
				$("#pieChartLoading").show();
				$("#barChartLoading").show();
				masterReflesh()
			});

			$("#layout1").on('click',function() {
				$("#pieChartLoading").show();
				$("#barChartLoading").show();
				refleshMapChart();
				refleshBarChart();
				refleshCircleChart();
			});

			$("#layout2").on('click',function() {
				$("#pieChartLoading").show();
				$("#barChartLoading").show();
				refleshMapChart();
				refleshBarChart();
				refleshCircleChart();
			});

			$("#layout3").on('click',function() {
				$("#pieChartLoading").show();
				$("#barChartLoading").show();
				refleshMapChart();
				refleshBarChart();
				refleshCircleChart();
			});
		});

		//자동새로고침시작 함수
		var checknum;
		var timenum;
		function refleshAutomatic(timevalue) {
			var check = $("#monitoring").is(":checked");
			var tensec = $('#tensec').is(":checked");
			var onemin = $('#onemin').is(":checked");
			var twomin = $('#twomin').is(":checked");
			var fivemin = $('#fivemin').is(":checked");
			var ftmin = $('#ftmin').is(":checked");

			if(check===true){
				checknum = 1;
			}else{
				checknum = 0;
			}

			if(tensec===true){
				timenum=1;
			}else if(onemin===true){
				timenum=2;
			}else if(twomin===true){
				timenum=3;
			}else if(fivemin===true){
				timenum=4;
			}else if(ftmin===true){
				timenum=5;
			}

			var params = {
				userid:$('#userid').val(),
				checknum:checknum,
				timenum:timenum,
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });
			$.ajax({
				url:'/api/dashboard/refleshcheck',
				type : 'post',
				data : params,
				cache:false,
				error:function(request) {
					ajaxErrorMsg(request);
				},
				success: function(){
					//console.log("아작스 실행완료!");

					if(timevalue==null){
						var monitorTime = $('input[name="monitorTime"]:checked').val();
					}else{
						monitorTime=timevalue
					}

					if(check===true){
						AutoStart(monitorTime)
					}else if(check===false){
						callStop()
					}

				}
			});
		}

		var timerId = null;
		var timeprogress = 0;

		// 자동새로고침시작
		function AutoStart(monitorTime) {
			if(timerId != null) {
				clearInterval(timerId);
			}
			timeInterval = monitorTime;
			progresssDisplay();
			timerId = setInterval(progresssDisplay, 100);
		}

		// 그냥새로고침
		function masterReflesh() {

			var deviceid = $("#deviceIds").val().split(',');
			var deviceinstall = $("#deviceInstalls").val().split(',');
			var devicesubname = $("#deviceSubnames").val().split(',');
			var devicefile = $("#devicefiles").val().split(',');

			var deviceidArr = [];
			var deviceinstallArr = [];
			var devicesubnameArr = [];
			var devicefileArr = [];

			for (var i = 0; i < deviceid.length; i++) {
				deviceidArr.push(deviceid[i]);
				deviceinstallArr.push(deviceinstall[i]);
				devicesubnameArr.push(devicesubname[i]);
				devicefileArr.push(devicefile[i]);
			}

			deviceAWSListViewReflesh(deviceidArr, deviceinstallArr,devicefileArr);
			pushDeviceId(deviceidArr, devicesubnameArr,0);
		}

		// 자동새로고침 함수 호출
		function progresssDisplay() {

			var deviceid = $("#deviceIds").val().split(',');
			var deviceinstall = $("#deviceInstalls").val().split(',');
			var devicesubname = $("#deviceSubnames").val().split(',');
			var devicefile = $("#devicefiles").val().split(',');

			var deviceidArr = [];
			var deviceinstallArr = [];
			var devicesubnameArr = [];
			var devicefileArr = [];

			for (var i = 0; i < deviceid.length; i++) {
				deviceidArr.push(deviceid[i]);
				deviceinstallArr.push(deviceinstall[i]);
				devicesubnameArr.push(devicesubname[i]);
				devicefileArr.push(devicefile[i]);
			}

			timeprogress += 1;

			if (timeprogress * 100 >= timeInterval) {
				timeprogress = 0;
				deviceAWSListViewReflesh(deviceidArr, deviceinstallArr,devicefileArr);
				pushDeviceId(deviceidArr, devicesubnameArr,0);
				$("#mapChartLoading").show();
				$("#pieChartLoading").show();
				$("#barChartLoading").show();
			}
			var progressrate = timeprogress * 10000 / timeInterval;
			$('#progressbar').css("width", progressrate + "%")
			// $('#progress').html(timeprogress);
		}

		// 자동새로고침종료
		function callStop() {
			if(timerId != null) {
				clearInterval(timerId);
			}
		}

		// 맵 새로고침
		function refleshMapChart() {
			var params = {
				emNumber:$('#s_emNumber').val(),
				emType:$('#s_emType').val(),
				emCountry:$('#s_emCountry').val(),
				emLocation:$('#s_emLocation').val(),
			};
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });
			$.ajax({
				url:'/api/dashboard/deviceInfoList',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					var pushValue = [];
					$.each(res.data.datalist, function(key, value){
						pushValue.push(nvl(value.emNumber,"확 인 불 가"));
					});
					MapChartDeviceId(pushValue);
				}
			});
		}

		// 원차트 새로고침
		function refleshCircleChart() {
			var params = {
				emNumber:$('#s_emNumber').val(),
				emType:$('#s_emType').val(),
				emCountry:$('#s_emCountry').val(),
				emLocation:$('#s_emLocation').val(),
			};
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });
			$.ajax({
				url:'/api/dashboard/deviceInfoList',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					var pushValue = [];
					$.each(res.data.datalist, function(key, value){
						pushValue.push(nvl(value.emNumber,"확 인 불 가"));
					});
					CircleChartDeviceId(pushValue);
				}
			});
		}

		// 막대차트 새로고침
		function refleshBarChart() {
			var params = {
				emNumber:$('#s_emNumber').val(),
				emType:$('#s_emType').val(),
				emCountry:$('#s_emCountry').val(),
				emLocation:$('#s_emLocation').val(),
			};
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });
			$.ajax({
				url:'/api/dashboard/deviceInfoList',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					var pushValue = [];
					$.each(res.data.datalist, function(key, value){
						pushValue.push(nvl(value.emNumber,"확 인 불 가"));
					});
					BarChartDeviceId(pushValue);
				}
			});
		}

		// 장치리스트 출력
		function deviceListView() {
			if ($("#intervaltime").val().trim() === '') {
				alertCaution("조회할 날짜를 선택해주세요");
				return false;
			}
			$("#mapChartLoading").show();
			$("#pieChartLoading").show();
			$("#barChartLoading").show();

			var $deviceList = $('#deviceList');

			var params = {
				emNumber:$('#s_emNumber').val(),
				emType:$('#s_emType').val(),
				emCountry:$('#s_emCountry').val(),
				emLocation:$('#s_emLocation').val(),
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/dashboard/deviceInfoList',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					//화면 출력
					//console.log("출력시작")
					var html2 = '';
					var html = '';
					var pushValue = [];
					var installDate = [];
					var subname = [];
					var files = [];

					var idx = 0;

					$.each(res.data.datalist, function(key, value){
						html2 += '<li class="c-list__item">';
						html2 += '<div class="equipment">';
						html2 += '<div id='+'mask'+idx+' class="c-loader">';
						html2 += '<div id='+'loading'+idx+' class="c-loader__active c-loader__active--ring"></div>';
						html2 += '</div>';
						html2 += '</div>';
						html2 += '</li>';

						html += '<li class="c-list__item">';
						html += '<div id='+'listTest'+idx+' class="equipment">';
						html += '<div class="equipment__section">';
						html += '<h4 class="equipment__section-title">장치 상세 정보</h4>';
						html += '<ul class="equipment__info">';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'장비 ID : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.emNumber,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'모델타입 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.emType,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'모델명 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.mdName,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'최대적재량 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.mdMaximumPayload,"확 인 불 가")+nvl(value.mdUnit,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'운영사 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.company,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'국가/지역 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.emCountry,"확 인 불 가")+'/'+nvl(value.emLocation,"확 인 불 가")+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'설치일자 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(value.emInstallDate,"확 인 불 가").substring(0,4)+"년 "+nvl(value.emInstallDate,"확 인 불 가").substring(4,6)+"월 "+nvl(value.emInstallDate,"확 인 불 가").substring(6,8)+"일"+'</span>';
						html += '</li>';
						html += '</ul>';
						html += '</div>';
						html += '</div>';
						html += '</li>';

						idx++;

						pushValue.push(nvl(value.emNumber,"확 인 불 가"));
						installDate.push(nvl(value.emInstallDate,"확 인 불 가"));
						files.push(nvl(value.filePath+'/s_'+value.saveFileName,"확 인 불 가"));
					});
					//console.log("보내는 장비번호 : "+pushValue+" 보내는 설치날짜 : "+installDate);
					$deviceList.html(html2);
					setTimeout(function(){
						for(var i=0; i<pushValue.length; i++){
							$("#mask"+i).removeClass("c-loader");
							$("#loading"+i).removeClass("c-loader__active c-loader__active--ring");
						}
						$deviceList.html(html);
						deviceAWSListView(pushValue,installDate,files);
						pushDeviceId(pushValue,1);
						$("#deviceIds").val(pushValue);
						$("#deviceInstalls").val(installDate);
						$("#deviceSubnames").val(subname);
						$("#devicefiles").val(files);
					},1000);
				}
			});
		}

		// ASW 장치 데이터리스트
		function deviceAWSListView(pushValue,installDate,files) {
			// console.log("장비리스트 뿌리기 시작")
			// console.log("받은 장비번호 : "+pushValue);
			// console.log("받은 설치날짜 : "+installDate);
			// console.log("받은 파일경로 : "+files);

			var deviceIds = [];
			for(i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
				// console.log("emNumber["+i+"]" +":"+pushValue[i]);
			}
			// deviceIds.push("ISOL-KR-SEL-0004");
			// console.log("장비배열 : "+deviceIds)

			var installDayDatas = [];
			var today = new Date();

			//운영일구하기
			for(i=0; i<installDate.length; i++){
				var dateString = installDate[i];
				var dateObj = new Date(dateString.substring(0,4),Number(dateString.substring(4,6))-1,dateString.substring(6,8));
				//console.log("dateObj :"+dateObj);
				date1 = parseInt(today.getTime()/1000);
				date2 = parseInt(dateObj.getTime()/1000);
				var timeDifference = date1 - date2;
				var timeDifferenceInHours = timeDifference / 60 / 60;
				var betweenDay = timeDifferenceInHours  / 24;
				//console.log("betweenDay :"+betweenDay);
				installDayDatas.push(parseInt(betweenDay));
			}
			// console.log("installDatas :"+installDatas);
			// console.log("운영일 :"+installDayDatas);

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr,
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/dashboard/deviceAWSListView',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					//화면 출력
					var htmls = [];
					var htmls2 = [];
					var htmls3 = [];

					var idx = 0;
					var baseurl = res.data.awss3url;

					var devicetimeLength = res.data.deviceOnOffTime.length;
					var deviceOnOffline = [];
					var deviceOnOfftime = [];
					var devicetimeIdx = [];
					var week = ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'];
					for(var i=0; i<devicetimeLength; i++){
						if(res.data.deviceOnOffTime[i]!=="") {
							var deviceOnOffTimeStamp = new Date(res.data.deviceOnOffTime[i]);
							//console.log("deviceOnOffTimeStamp : "+deviceOnOffTimeStamp);
							var deviceOnOffYear = deviceOnOffTimeStamp.getFullYear();
							var deviceOnOffMonth = Number(deviceOnOffTimeStamp.getMonth() + 1);
							if (deviceOnOffMonth < 10) {
								deviceOnOffMonth = "0"+deviceOnOffMonth
							}
							var deviceOnOffDate = deviceOnOffTimeStamp.getDate();
							if (deviceOnOffDate < 10) {
								deviceOnOffDate = "0" + deviceOnOffDate
							}
							var deviceOnOffHour = deviceOnOffTimeStamp.getHours();
							if (deviceOnOffHour < 10) {
								deviceOnOffHour = "0" + deviceOnOffHour
							}
							var deviceOnOffMinute = deviceOnOffTimeStamp.getMinutes();
							if (deviceOnOffMinute < 10) {
								deviceOnOffMinute = "0" + deviceOnOffMinute
							}
							var deviceOnOffSecond = deviceOnOffTimeStamp.getSeconds();
							if (deviceOnOffSecond < 10) {
								deviceOnOffSecond = "0" + deviceOnOffSecond
							}
							var deviceOnOffDay = deviceOnOffTimeStamp.getDay();
							var devicetime = deviceOnOffYear + '-' + deviceOnOffMonth + '-' + deviceOnOffDate + ' ' + deviceOnOffHour + ':' + deviceOnOffMinute + ':' + deviceOnOffSecond + ' (' + week[deviceOnOffDay] + ')';
							//console.log("devicetime : "+devicetime);
							devicetimeIdx.push(devicetime);
						}else{
							devicetimeIdx.push("");
						}
						deviceOnOffline.push(res.data.deviceOnOffstatus[i]);
						deviceOnOfftime.push(res.data.deviceOnOffTime[i]);
					}

					$.each(res.data.devices, function () {
						var html = '';
						var html2 = '';
						var html3 = '';

						html2 += '<div id='+'states'+idx+' class="equipment__section">';
						html2 += '<div id='+'stateLoading'+idx+' class="c-loader">';
						html2 += '<div class="c-loader__active c-loader__active--ring"></div>';
						html2 += '</div>';
						if(res.data.status[idx]==="정상"){
							html2 += '<span class="equipment__stat normal">'+'정상'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else if(res.data.status[idx]==="주의"){
							html2 += '<span class="equipment__stat caution">'+'주의'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else if(res.data.status[idx]==="심각"){
							html2 += '<span class="equipment__stat severe">'+'심각'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else{
							html2 += '<span class="equipment__stat severe">'+'알수없음'+'</span>';
							html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							html2 += '</div>';
						}
						html2 += '</div>';

						html += '<div id='+'details'+idx+' class="equipment__section">';
						html += '<div id='+'detailLoading'+idx+' class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						html += '<h4 class="equipment__section-title">상태 상세 정보</h4>';
						html += '<ul class="equipment__info">';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'운영일 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(installDayDatas[idx],"확 인 불 가 ")+'일'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'온도 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.temp_brd[idx],"확 인 불 가")+'℃'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'배출량 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.level[idx],"확 인 불 가")+'%'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'배터리잔량 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.batt_level[idx],"확 인 불 가")+'%'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'태양광판넬 전류 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.solar_current[idx],"확 인 불 가")+'A'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'태양광판넬 전압 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.solar_voltage[idx],"확 인 불 가")+'V'+'</span>';
						html += '<li class="equipment__info-item">';
						html += '<input type="button" class="c-button c-button--point" value="장비위치 이동" onclick="mapMove('+nvl(res.data.gps_laDatas[idx],"확 인 불 가")+','+nvl(res.data.gps_loDatas[idx],"확 인 불 가")+')" />';
						html += '</li>';
						html += '</ul>';
						html += '</div>';

						html3 += '<div id='+'graphs'+idx+' class="equipment__section">';
						html3 += '<div id='+'timechartLoading'+idx+' class="c-loader">';
						html3 += '<div class="c-loader__active c-loader__active--ring"></div>';
						html3 += '</div>';
						html3 += '<canvas id='+'timeStampChart'+idx+' style="width: 100%;height: 220px;"></canvas>';
						html3 += '</div>';

						htmls.push(html);
						htmls2.push(html2);
						htmls3.push(html3);

						$('#listTest'+idx).append(htmls[idx]);
						$('#listTest'+idx).prepend(htmls2[idx]);
						$('#listTest'+idx).append(htmls3[idx]);

						timeStamp(nvl(res.data.devices[idx],"확 인 불 가"),idx);

						idx++
					});
					//console.log("출력완료");
				}
			});
		}

		// ASW 장치 데이터리스트(새로고침)
		function deviceAWSListViewReflesh(pushValue,installDate,files) {
			// console.log("장비리스트 뿌리기 시작")
			// console.log("받은 장비번호 : "+pushValue);
			// console.log("받은 설치날짜 : "+installDate);

			var deviceIds = [];
			for(i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
				// console.log("emNumber["+i+"]" +":"+pushValue[i]);
			}
			// deviceIds.push("ISOL-KR-SEL-0004");
			// console.log("장비배열 : "+deviceIds)

			var installDayDatas = [];
			var today = new Date();

			//운영일구하기
			for(i=0; i<installDate.length; i++){
				var dateString = installDate[i];
				var dateObj = new Date(dateString.substring(0,4),Number(dateString.substring(4,6))-1,dateString.substring(6,8));
				//console.log("dateObj :"+dateObj);
				date1 = parseInt(today.getTime()/1000);
				date2 = parseInt(dateObj.getTime()/1000);
				var timeDifference = date1 - date2;
				var timeDifferenceInHours = timeDifference / 60 / 60;
				var betweenDay = timeDifferenceInHours  / 24;
				//console.log("betweenDay :"+betweenDay);
				installDayDatas.push(parseInt(betweenDay));
			}
			// console.log("installDatas :"+installDatas);
			// console.log("운영일 :"+installDayDatas);

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr,
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/dashboard/deviceAWSListView',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res){
					//화면 출력
					var htmls = [];
					var htmls2 = [];
					var htmls3 = [];

					var idx = 0;
					var baseurl = res.data.awss3url;

					var devicetimeLength = res.data.deviceOnOffTime.length;
					var deviceOnOffline = [];
					var deviceOnOfftime = [];
					var devicetimeIdx = [];
					var week = ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'];
					for(var i=0; i<devicetimeLength; i++){
						if(res.data.deviceOnOffTime[i]!=="") {
							var deviceOnOffTimeStamp = new Date(res.data.deviceOnOffTime[i]);
							var deviceOnOffYear = deviceOnOffTimeStamp.getFullYear();
							var deviceOnOffMonth = Number(deviceOnOffTimeStamp.getMonth() + 1);
							if (deviceOnOffMonth < 10) {
								deviceOnOffMonth = "0"+deviceOnOffMonth
							}
							var deviceOnOffDate = deviceOnOffTimeStamp.getDate();
							if (deviceOnOffDate < 10) {
								deviceOnOffDate = "0" + deviceOnOffDate
							}
							var deviceOnOffHour = deviceOnOffTimeStamp.getHours();
							if (deviceOnOffHour < 10) {
								deviceOnOffHour = "0" + deviceOnOffHour
							}
							var deviceOnOffMinute = deviceOnOffTimeStamp.getMinutes();
							if (deviceOnOffMinute < 10) {
								deviceOnOffMinute = "0" + deviceOnOffMinute
							}
							var deviceOnOffSecond = deviceOnOffTimeStamp.getSeconds();
							if (deviceOnOffSecond < 10) {
								deviceOnOffSecond = "0" + deviceOnOffSecond
							}
							var deviceOnOffDay = deviceOnOffTimeStamp.getDay();
							var devicetime = deviceOnOffYear + '-' + deviceOnOffMonth + '-' + deviceOnOffDate + ' ' + deviceOnOffHour + ':' + deviceOnOffMinute + ':' + deviceOnOffSecond + ' (' + week[deviceOnOffDay] + ')';
							devicetimeIdx.push(devicetime);
						}else{
							devicetimeIdx.push("");
						}
						deviceOnOffline.push(res.data.deviceOnOffstatus[i]);
						deviceOnOfftime.push(res.data.deviceOnOffTime[i]);
					}

					$.each(res.data.devices, function () {
						var html = '';
						var html2 = '';
						var html3 = '';

						html2 += '<div id='+'stateLoading'+idx+' class="c-loader">';
						html2 += '<div class="c-loader__active c-loader__active--ring"></div>';
						html2 += '</div>';
						if(res.data.status[idx]==="정상"){
							html2 += '<span class="equipment__stat normal">'+'정상'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else if(res.data.status[idx]==="주의"){
							html2 += '<span class="equipment__stat caution">'+'주의'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else if(res.data.status[idx]==="심각"){
							html2 += '<span class="equipment__stat severe">'+'심각'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]!==""){
								html2 += '<span>'+'최종종료일시 : '+devicetimeIdx[idx]+'</span>';
							}else if(deviceOnOffline[idx]===false && deviceOnOfftime[idx]===""){
								html2 += '<span>'+'접속이력없음'+'</span>';
							}
							html2 += '</div>';
						}else{
							html2 += '<span class="equipment__stat severe">'+'알수없음'+'</span>';
							if(res.data.deviceOnOffstatus[idx]==="true"){
								html2 += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html2 += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html2 += '<div class="equipment__img">';
							html2 += '<img src="'+baseurl+files[idx]+'" alt="이미지" />';
							html2 += '</div>';
						}

						html += '<div id='+'detailLoading'+idx+' class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						html += '<h4 class="equipment__section-title">상태 상세 정보</h4>';
						html += '<ul class="equipment__info">';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'운영일 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(installDayDatas[idx],"확 인 불 가 ")+'일'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'온도 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.temp_brd[idx],"확 인 불 가")+'℃'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'배출량 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.level[idx],"확 인 불 가")+'%'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'배터리잔량 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.batt_level[idx],"확 인 불 가")+'%'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'태양광판넬 전류 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.solar_current[idx],"확 인 불 가")+'A'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'태양광판넬 전압 : '+'</span>';
						html += '<span class="equipment__info-value">'+nvl(res.data.solar_voltage[idx],"확 인 불 가")+'V'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<input type="button" class="c-button c-button--point" value="장비위치 이동" onclick="mapMove('+nvl(res.data.gps_laDatas[idx],"확 인 불 가")+','+nvl(res.data.gps_loDatas[idx],"확 인 불 가")+')" />';
						html += '</li>';
						html += '</ul>';

						html3 += '<div id='+'timechartLoading'+idx+' class="c-loader">';
						html3 += '<div class="c-loader__active c-loader__active--ring"></div>';
						html3 += '</div>';
						html3 += '<canvas id='+'timeStampChart'+idx+' style="width: 100%;height: 220px;"></canvas>';

						htmls.push(html);
						htmls2.push(html2);
						htmls3.push(html3);

						$('#states'+idx).html(htmls2[idx]);
						$('#details'+idx).html(htmls[idx]);
						$('#graphs'+idx).html(htmls3[idx]);

						timeStamp(nvl(res.data.devices[idx],"확 인 불 가"),idx);

						idx++
					});
					//console.log("출력완료");
				}
			});
		}

		// 타임스탬프 그래프함수
		function timeStamp(pushValue,idx){
			// console.log("받아온 아이디 : "+pushValue);
			// console.log("받아온 시간 : "+$('#intervaltime').val());

			var params = {
				deviceid:pushValue,
				intervaltime:$('#intervaltime').val()
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/dashboard/devicehitory',
				type : 'post',
				data : params,
				cache:false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function(res) {
					statuscode= res.data.statusCode;
					// console.log("statuscode : "+statuscode)

					if (statuscode ===200) {
						// console.log("타임스탬프 그래프그리기 시작")

						var timeStamp = []; //타임스탬프
						var temp_brd = []; //온도
						var level = []; //배출량
						var batt_level = []; //배터리잔량
						var testTimeStamp = [];
						$.each(res.data.datarow1, function (key, value) {
							// console.log("해당아이디 : "+value.deviceid);
							// console.log("타임스탬프 : "+value.timestamp);
							// console.log("온도 : "+value.temp_brd);
							// console.log("배출량 : "+value.level);
							// console.log("배터리잔량 : "+value.batt_level);

							var timestamp = parseInt(value.timestamp); // value.timestamp(밀리세컨드)는 문자열로 받아오기때문에 정수형으로 변환해준다.
							var date = new Date(timestamp);
							var month = date.getMonth()+1; // 1월을 0월로 보기때문에 월에 +1을 해준다.
							var day = date.getDate();
							var minutes = date.getMinutes();
							var seconds = date.getSeconds();
							if(day < 10){
								day = "0"+day;
							}
							if(minutes < 10){
								minutes = "0"+minutes;
							}
							if(seconds < 10){
								seconds = "0"+seconds;
							}
							var time =month+"월"+day+"일 "+date.getHours()+":"+minutes+":"+seconds;

							// console.log("날짜 : "+time)
							// console.log("")
							testTimeStamp.push(parseInt(value.timestamp));
							timeStamp.push(time);
							temp_brd.push(value.temp_brd);
							level.push(value.level);
							batt_level.push(value.batt_level);
						});
						var days = $("#intervaltime").val(); // 기간선택 시간

						// 온도최대값,최소값 계산(y축그래프)
						temp_brd_Max = Math.max.apply(0, temp_brd); // 온도최대값
						temp_brd_Min = Math.min.apply(0, temp_brd); // 온도최소값
						tempMap = (temp_brd_Max+15).toFixed(0);
						tempMin = (temp_brd_Min-15).toFixed(0);
						if(tempMap/5!==0){
							tempMaxsub = tempMap.substring(1,2);
							tempBrdMax = parseInt(tempMap)-parseInt(tempMaxsub);
						}else{
							tempBrdMax = tempMap;
						}
						if(tempMin/5!==0){
							tempMinsub = tempMin.substring(1,2);
							tempBrdMin = parseInt(tempMin)-parseInt(tempMinsub);
						}else{
							tempBrdMin = tempMin;
						}

						//var ctx = document.getElementById('timeStampChart'+idx).getContext('2d');
						var ctx = document.getElementById('timeStampChart'+idx);

						var nowDate = new Date();
						// 라벨 최대값 구하기 (현재날짜)
						var max_milliseconds = nowDate.getTime();
						// 라벨 최소값 구하기
						var min_milliseconds = nowDate.setHours(nowDate.getHours()-$("#intervaltime").val());
						// console.log("현재날짜 : "+max_milliseconds);
						// console.log("이전날짜 : "+min_milliseconds);
						var barChartData = {
							labels: testTimeStamp,
							datasets: [{
								type: 'line',
								label: '온도',
								yAxisID: 'y',
								backgroundColor: "#e35f5f",
								borderWidth: 2,
								borderColor: "#e35f5f",
								data: temp_brd,
								fill: false
							}, {
								type: 'line',
								label: '배출량',
								yAxisID: 'x',
								backgroundColor: "#48ae63",
								borderWidth: 2,
								borderColor: "#48ae63",
								data: level,
								fill: false
							},{
								type: 'line',
								label: '배터리잔량',
								yAxisID: 'x',
								backgroundColor: "#ffc600",
								borderWidth: 2,
								borderColor: "#ffc600",
								data: batt_level,
								fill: false
							}]
						};

						new Chart(ctx, {
							data: barChartData,
							options: {
								elements: {
									point:{
										radius: 0
									}
								},
								maintainAspectRatio: false,
								stacked : true,
								tooltips: { //팁(모드설정)
									mode: 'index',
									intersect: false
								},
								hover: { //점 나오기
									mode: 'index',
									intersect: false
								},
								scales: {
									xAxes: [{
										gridLines: {
											drawOnChartArea: false
										},
										display: false,
										type: 'time',
										time: {
											min: min_milliseconds,
											max: max_milliseconds,
											tooltipFormat: 'YYYY'+'년'+'MM'+'월'+'DD'+'일 '+'HH:mm:ss a',
										}
									}],
									yAxes: [{
										ticks: {
											callback: function(value) {
												return value+'%';
											},
											max: 100,
											min: 0,
											stepSize: 20
										},
										id: 'x',
										type: 'linear',
										display: true,
										position: 'left'
									},{
										ticks: {
											callback: function(value) {
												return value+'℃';
											},
											max: tempBrdMax,
											min: tempBrdMin
										},
										id: 'y',
										type: 'linear',
										display: true,
										position: 'right',
										gridLines: {
											drawOnChartArea: false
										}
									}]
								}
							}
						});
					}
					setTimeout(function(){
						$("#stateLoading"+idx).hide();
						$("#detailLoading"+idx).hide();
						$("#timechartLoading"+idx).hide();
					},2000);
				}
			});
		}

		//쓰레기양 차트
		function barChart(barData,nowtimestamp,beforetimestamp,timestamps) {
			// console.log("barData : "+barData);
			// console.log("barData길이 : "+barData.length);
			// console.log("어제날짜 타임스탬프 : "+nowtimestamp);
			// console.log("30일전 타임스탬프 : "+beforetimestamp);
			// console.log("timestamps : "+timestamps);
			if(window.chart && window.chart !== null){
				window.chart.destroy();
			}

			var ctx = document.getElementById('bar_chart');
			var barChartData = {
				labels: timestamps,
				datasets: [{
					type: 'line',
					label: '평균값',
					yAxisID: '평균',
					backgroundColor: "#48ae63",
					borderWidth: 4,
					borderColor: "#48ae63",
					data: barData,
					fill: false
				}]
			};

			window.chart = new Chart(ctx, {
				data: barChartData,
				options: {
					// legend: {
					// 	display: false
					// },
					elements: {
						point:{
							radius: 0
						}
					},
					maintainAspectRatio: false,
					stacked : true,
					tooltips: { //팁(모드설정)
						titleFontSize: 15,
						bodyFontSize: 15,
						mode: 'index',
						intersect: false
					},
					hover: { //점 나오기
						mode: 'index',
						intersect: false
					},
					scales: {
						xAxes: [{
							gridLines: {
								drawOnChartArea: false
							},
							display: false,
							type: 'time',
							time: {
								min: beforetimestamp,
								max: nowtimestamp,
								tooltipFormat: 'YYYY'+'년'+'MM'+'월'+'DD'+'일 '+'HH:mm:ss a',
							}
						}],
						yAxes: [{
							ticks: {
								callback: function(value) {
									return value+'%';
								},
								max: 100,
								min: 0,
								stepSize: 10
							},
							id: '평균',
							type: 'linear',
							display: true,
							position: 'left'
						}]
					}
				}
			});
			$("#barChartLoading").hide();
		}

		// Map 새로고침
		function MapChartDeviceId(pushValue) {
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			var deviceIds = [];
			for (var i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
			}

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr
			};

			$.ajax({
				url: '/api/dashboard/dataMapGraph',
				type: 'post',
				data : params,
				cache: false,
				error: function (request) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}
					mapDeviceId(res.data.map_data_columns,res.data.bar_data_columns,res.data.statusDatas);
				}
			});
		}

		// Circle그래프 새로고침
		function CircleChartDeviceId(pushValue) {
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			var deviceIds = [];
			for (var i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
			}

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr
			};

			$.ajax({
				url: '/api/dashboard/dataCircleGraph',
				type: 'post',
				data : params,
				cache: false,
				error: function (request) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}
					//상태값 차트
					circleChart(res.data.circle_data_columns,res.data.circle_data_count);
					$("#pieChartLoading").hide();
				}
			});
		}

		// Bar그래프 새로고침
		function BarChartDeviceId(pushValue) {
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			var deviceIds = [];
			for (var i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
			}

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr
			};

			$.ajax({
				url: '/api/dashboard/dataBarGraph',
				type: 'post',
				data : params,
				cache: false,
				error: function (request) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}
					//쓰레기양 차트
					barChart(res.data.averages,res.data.nowtimestamp,res.data.beforetimestamp,res.data.timestamps);
				}
			});
		}

		// aws deviceID값 push하는 함수 next -> 차트만들기
		function pushDeviceId(pushValue,num) {
			// console.log("pushValue : "+pushValue)
			// console.log("subname : "+subname)
			// console.log("차트그래프 그리기 시작")

			//상태값 차트 , 쓰레기양 차트
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

			var deviceIds = [];
			for (var i=0; i<pushValue.length; i++){
				deviceIds.push(pushValue[i]);
			}
			//console.log("deviceIds : "+deviceIds)
			// deviceIds.push("ISOL-KR-SEL-0004");

			var itemJson = {};
			itemJson.deviceids = deviceIds;
			var devicestr = JSON.stringify(itemJson);

			var params = {
				deviceids:devicestr
			};

			$.ajax({
				url: '/api/dashboard/dataGraph',
				type: 'post',
				data : params,
				cache: false,
				error: function (request) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}
					//상태값 차트
					circleChart(res.data.circle_data_columns,res.data.circle_data_count);
					//쓰레기양 차트
					barChart(res.data.averages,res.data.nowtimestamp,res.data.beforetimestamp,res.data.timestamps);
					//맵에 장치보기
					if(num===1){
						mapDeviceId(res.data.map_data_columns,res.data.bar_data_columns,res.data.statusDatas);
						$("#mapChartLoading").hide();
					}
					$("#pieChartLoading").hide();
					//console.log("차트그래프 그리기 완료, 맵 장비 출력완료")
				}
			});
		}

		// 맵 차트
		function mapDeviceId(map_data_columns,bar_data_columns,statusDatas,pathobj) {
			//console.log("map_data_columns : "+ map_data_columns)

			var locations = map_data_columns;

			//var map;
			map = new google.maps.Map(document.getElementById('map'), {
				center: {lat: 37.14450, lng: 127.03312},
				zoom: 8,
				mapTypeControl: false,
				streetViewControl: false
			});

			var i;
			var iconSrc = [];

			iconSrc['정상'] = "/assets/images/marker.png";
			iconSrc['주의'] = "/assets/images/marker--caution.png";
			iconSrc['심각'] = "/assets/images/marker--severe.png";

			var infowindow = new google.maps.InfoWindow();

			var bounds = new google.maps.LatLngBounds();

			for (i = 0; i < map_data_columns.length; i++) {
				if (map_data_columns[i][1] === 0 || map_data_columns[i][2] === 0) {
					continue;
				}

				marker = new google.maps.Marker({
					position: new google.maps.LatLng(map_data_columns[i][1], map_data_columns[i][2]),
					map: map,
					animation: google.maps.Animation.DROP,
					icon: iconSrc[locations[i][3]]
				});

				bounds.extend(marker.position);

				google.maps.event.addListener(marker, 'click', (function (marker, i) {
					var content =
							'<div class="iw-container" id="iw-container">' +
							'<h2>' + (map_data_columns[i][0]) + '</h2>' +
							'<dl>' +
							'<dt>' + '상태 : ' + statusDatas[i] + '</dt>' +
							'<dd>' + '배출량 : ' + bar_data_columns[i + 1] + '%' + '</dd>' +
							'</dl>' +
							'</div>';
					return function () {
						infowindow.setContent(content);
						infowindow.open(map, marker);

						if (marker.getAnimation() != null) {
							marker.setAnimation(null);
						} else {
							marker.setAnimation(google.maps.Animation.BOUNCE);
							setTimeout(function () {
								marker.setAnimation(null);
							}, 1500);
						}
					}
				})(marker, i));
			}map.fitBounds(bounds);
		}

		// 구글버전 directions
		// var directionsDisplay;
		// var directionsService;
		// var directionsMap;
		// var z = document.getElementById("map");
		// var start;
		// var end;
		//
		// function getDirections() {
		//
		// 	directionsDisplay = new google.maps.DirectionsRenderer();
		//
		// 	var directionsOptions = {
		// 		zoom:12,
		// 		mapTypeControl: false,
		// 		streetViewControl: false
		// 	};
		// 	directionsMap = new google.maps.Map(document.getElementById("map"), directionsOptions);
		// 	directionsDisplay.setMap(directionsMap);
		// 	calcRoute();
		// }
		//
		// function calcRoute() {
		//
		// 	directionsService = new google.maps.DirectionsService();
		//
		// 	//travelMode:DRIVING,WALKING,BICYCLING,TRANSIT
		//
		// 	start = new google.maps.LatLng(39.052213,125.729329);
		// 	end = new google.maps.LatLng(39.023130, 125.773078);
		// 	//end = new google.maps.LatLng(38.925900, -76.786412);
		// 	var request = {
		// 		origin:start,
		// 		destination:end,
		// 		travelMode: google.maps.TravelMode.DRIVING
		// 	};
		// 	directionsService.route(request, function(result, status) {
		// 		if (status === google.maps.DirectionsStatus.OK) {
		// 			directionsDisplay.setDirections(result);
		// 		}
		// 	});
		// }

		// 장비위치이동 버튼을 누르면 실행되는 함수
		function mapMove(lat,lng) {
			if(lat===0 || lng===0){
				alertCaution("위치 데이터가 없습니다.");
				return false;
			}
			//var center = new google.maps.LatLng(lat, lng);
			var center = new google.maps.LatLng(lat, lng);
			map.setZoom(18);
			//map.panTo(center);
			map.panTo(center);
			$('html').scrollTop(70);
		}

		//상태값 차트
		function circleChart(circle_data_columns,circle_data_count){
			$("#statusAll").text(circle_data_count[0]);
			$("#statusNomal").text(circle_data_count[1]);
			$("#statusCaution").text(circle_data_count[2]);
			$("#statusSerious").text(circle_data_count[3]);

			c3.generate({
				bindto: "#pie_chart",
				data: {
					columns: circle_data_columns,
					type: 'pie'
				},
				tooltip: {
					format: {
						value: function (value) {
							return value + '개';
						}
					}
				},
				color: {
					pattern: ['#48ae63', '#ffc600', '#e35f5f']
				}
			});
		}

		// 기간선택에 따라 보내는시간 변경하는 함수
		function intervaltimeChange(text) {
			if (text === "1Hours") {
				$("#intervaltime").val("1");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			}else if (text === "3Hours") {
				$("#intervaltime").val("3");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			}else if (text === "24Hours") {
				$("#intervaltime").val("24");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			} else if (text === "7Days") {
				$("#intervaltime").val("168");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			} else if (text === "1Month") {
				$("#intervaltime").val("720");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			} else if (text === "1Year") {
				$("#intervaltime").val("8760");
				$("#fromTo").hide();
				$("#dateFrom").val("");
				$("#dateTo").val("");
			} else if (text === "FromTo") {
				$("#intervaltime").val("");
				$("#fromTo").show();
			}
		}

		// 사용자정의 시간구하기 (날짜선택에따른 시간)
		function intervaltimeDate(date) {

			// console.log("date : " + date); 받아온날짜
			var today = new Date();
			var year = today.getFullYear();
			var month = today.getMonth()+1;
			var day = today.getDate();
			if(month < 10){
				month = "0"+month;
			}
			if(day < 10){
				day = "0"+day;
			}
			var todayData = year+"-"+month+"-"+day;
			$("#dateTo").val(todayData);

			var dateObj = new Date(date);

			if (today<dateObj) {
				alertCaution("현재 날짜보다 앞선 날짜는 <BR>선택할 수 없습니다.");
				$("#intervaltime").val("");
				$("#dateFrom").val("");
				$("#dateTo").val("");
				return false;
			}

			// console.log("today : " + today); // 오늘날짜
			// console.log("dateObj : " + dateObj); // 사용자정의 날짜
			var hours = parseInt(Math.abs(today - dateObj) / 36e5); // 36e5는 60 * 60 * 1000의 과학 표기법으로, 밀리 초 차이를 시간으로 환산하여 나눔.
			// console.log("hours : " + hours); // 정해진시간
			$("#intervaltime").val(hours);
		}

		// 국가,지역검색
		function LocationSetting(value) {
			// console.log("value : "+value);

			var params = {
				s_emCountry:value
			};

			var $s_emLocation = $("#s_emLocation");

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function (e, xhr) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url: '/api/dashboard/location',
				type: 'post',
				data: params,
				cache: false,
				error:function(request){
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}

					var html = '';
					html += '<option value ="">'+'전체'+'</option>';
					$.each(res.data.locationData, function (key, value) {
						html += '<option value ="' + echoNull2Blank(value.code) + '">' + echoNull2Blank(value.name)+ '</option>';
					});
					$s_emLocation.html(html);
				}
			});
		}

	</script>
</head>
<div layout:fragment="content" class="contents-body">
	<div class="page">
		<div class="page-title">
			<div class="page-title__left">
				<h2>대시보드</h2>
			</div>
			<div class="page-title__right">
				<div class="refresh-pop">
					<button id="refreshMaster" class="refresh-pop__btn">새로고침</button>
					<a href="#" class="refresh-pop__btn-pop"></a>
					<div class="refresh-pop__progress">
						<div id="progressbar"></div>
					</div>
					<ul class="refresh-pop__context">
						<li class="refresh-pop__box">
							<label><input id="monitoring" type="checkbox" onclick="refleshAutomatic()" />자동 새로 고침</label>
						</li>
						<li><span>새로고침 간격</span></li>
						<li>
							<label><input id="tensec" name="monitorTime" type="radio" value="10000" onclick="refleshAutomatic(this.value)" /><span>10초</span></label>
						</li>
						<li>
							<label><input id="onemin" name="monitorTime" type="radio" value="60000" onclick="refleshAutomatic(this.value)" /><span>1분</span></label>
						</li>
						<li>
							<label><input id="twomin" name="monitorTime" type="radio" value="120000" onclick="refleshAutomatic(this.value)" /><span>2분</span></label>
						</li>
						<li>
							<label><input id="fivemin" name="monitorTime" type="radio" value="300000" onclick="refleshAutomatic(this.value)" /><span>5분</span></label>
						</li>
						<li>
							<label><input id="ftmin" name="monitorTime" type="radio" value="1500000" onclick="refleshAutomatic(this.value)" /><span>15분</span></label>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="dashboard">
			<div class="dashboard__count">
				<div class="dashboard__count-item">
					<h4 class="dashbaord__count-title">전체</h4>
					<p class="dashboard__count-num" id='statusAll'></p>
				</div>
				<div class="dashboard__count-item">
					<h4 class="dashbaord__count-title">정상</h4>
					<p class="dashboard__count-num dashboard__count-num--normal" id='statusNomal'></p>
				</div>
				<div class="dashboard__count-item">
					<h4 class="dashbaord__count-title">관심</h4>
					<p class="dashboard__count-num dashboard__count-num--warning" id='statusCaution'></p>
				</div>
				<div class="dashboard__count-item">
					<h4 class="dashbaord__count-title">심각</h4>
					<p class="dashboard__count-num dashboard__count-num--danger" id='statusSerious'></p>
				</div>

				<div class="layout-select">
					<ul>
						<li><a href="#" id="layout1" class="loyout-select__btn loyout-select__01">레이아웃1</a></li>
						<li><a href="#" id="layout2" class="loyout-select__btn loyout-select__02">레이아웃2</a></li>
						<li><a href="#" id="layout3" class="loyout-select__btn loyout-select__03">레이아웃3</a></li>
					</ul>
				</div>
			</div>

			<div class="dashboard__row">
				<div class="panel panel--three panel--layout">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">설치위치</h4>
							<div class="panel__console">
								<button class="panel__button refresh" id="mapChart">새로고침</button>
							</div>
						</div>
						<div id="mapfold" class="panel__body">
							<div class="c-loader">
								<div id="mapChartLoading" class="c-loader__active c-loader__active--ring"></div>
							</div>
							<div class="map" id="map"></div>
						</div>
					</div>
				</div>
				<div class="panel panel--three panel--layout">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">상태</h4>
							<div class="panel__console">
								<button class="panel__button refresh" id="circleChart">새로고침</button>
							</div>
						</div>
						<div id="circlefold" class="panel__body">
							<div class="c-loader">
								<div id="pieChartLoading" class="c-loader__active c-loader__active--ring"></div>
							</div>
							<div class="panel__stat" id="pie_chart"></div>
						</div>
					</div>
				</div>
				<div class="panel panel--three panel--layout">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">배출량</h4>
							<div class="panel__console">
								<button class="panel__button refresh" id="barChart">새로고침</button>
							</div>
						</div>
						<div id="levelfold" class="panel__body">
							<div class="c-loader">
								<div id="barChartLoading" class="c-loader__active c-loader__active--ring"></div>
								<canvas class="panel__stat" id="bar_chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="dashboard__row">
				<!-- 검색영역 -->
				<div class="panel">
					<div class="panel__inner">
						<div class="panel__body panel__body--height-auto">
							<div class="panel__console">
								<div class="panel__console panel__console--left">
									<div class="c-btn-group">
										<h5 class="c-btn-group__title">기간 선택</h5>
										<div class="c-btn-group__list">
											<button onclick="intervaltimeChange(this.value)" id="removehour" value="1Hours" class="c-btn-group__button">1Hours</button>
											<button onclick="intervaltimeChange(this.value)" id="starthour" value="3Hours" class="c-btn-group__button">3Hours</button>
											<button onclick="intervaltimeChange(this.value)" value="24Hours" class="c-btn-group__button">24Hours</button>
											<button onclick="intervaltimeChange(this.value)" value="7Days" class="c-btn-group__button">7Days</button>
											<button onclick="intervaltimeChange(this.value)" value="1Month" class="c-btn-group__button">1Month</button>
											<button onclick="intervaltimeChange(this.value)" value="1Year" class="c-btn-group__button">1Year</button>
											<button onclick="intervaltimeChange(this.value)" value="FromTo" class="c-btn-group__button">FromTo</button>
										</div>
										<input type="hidden" id="intervaltime" value ="" readonly="readonly" />
										<input type="hidden" id="deviceIds" value ="" readonly="readonly" />
										<input type="hidden" id="deviceInstalls" value ="" readonly="readonly" />
										<input type="hidden" id="deviceSubnames" value ="" readonly="readonly" />
										<input type="hidden" id="devicefiles" value ="" readonly="readonly" />
									</div>
								</div>

								<div class="panel__console panel__console--right">
									<div class="c-float">
										<div class="c-float__item" id="fromTo" style="display: none">
											<div class="c-date-group" >
												<div class="c-date">
													<label for="dateFrom" class="c-date__label">from</label>
													<input type="text" class="c-text__input" id="dateFrom" placeholder="연 - 월 - 일" onchange="intervaltimeDate(this.value)" />
												</div>
												<div class="c-date">
													<label for="dateTo" class="c-date__label">today</label>
													<input type="text" class="c-text__input" id="dateTo" placeholder="연 - 월 - 일" readonly="readonly" />
												</div>
											</div>
										</div>

										<div class="c-float__item" style="padding-top: 15px;">
											<button id="closeMasterfold" class="c-button c-button--point">접기</button>
											<button id="openMasterfold" class="c-button c-button--point" style="display: none">펴기</button>
										</div>
										<div class="c-float__item" style="padding-top: 15px;">
											<button id="btnSearch" class="c-button c-button--point">조회</button>
										</div>
									</div>
								</div>
							</div>

							<div class="c-float c-float--flex">
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emType" class="c-select__label">모델 타입</label>
										<select id="s_emType" class="c-select__input">
											<option value="">전체</option>
											<option th:each ="equipdType : ${equipdTypes}"
													th:value="${equipdType.code}"
													th:text="${equipdType.name}">
											</option>
										</select>
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emCountry" class="c-select__label">국가</label>
										<select id="s_emCountry" class="c-select__input" onchange="LocationSetting(this.value)">
											<option value="">전체</option>
											<option th:each ="equipdCountry : ${equipdCountrys}"
													th:value="${equipdCountry.code}"
													th:text="${equipdCountry.name}">
											</option>
										</select>
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emLocation" class="c-select__label">지역</label>
										<select id="s_emLocation" class="c-select__input">
										</select>
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-text">
										<label for="s_emNumber" class="c-text__label">장비번호</label>
										<input id="s_emNumber" type="text" class="c-text__input" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="dashboard__row">
				<div class="panel">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">기기</h4>
						</div>
						<div class="panel__body panel__body--height-auto panel__body--non-padding">
							<ul id="deviceList" class="c-list equipment">
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<input type="hidden" id="userid" th:value="${userId}" readonly="readonly" />
	<input type="hidden" id="refleshCheck" th:value="${refleshCheck}" readonly="readonly" />
	<input type="hidden" id="refleshCount" th:value="${refleshCount}" readonly="readonly" />

</div>
</html>