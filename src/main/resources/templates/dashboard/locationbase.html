<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate ="~{layout/default}">
	  
	<head>
		<script>

			$(function() {
				if($("#headerMode").val()==="1"){
					$("#default_wrap").addClass('wrap');
					$("#header_dashboard").css('display','block');
				}else{
					$("#default_wrap").addClass('wrap nav--small');
					$("#header_dashboard").css('display','none');
				}

				$("#dateFrom").datepicker({});

				$("#removehour").removeClass(" active");
				$("#starthour").addClass(" active");
				$("#intervaltime").val("3");

				LocationSetting("");
				deviceMap();

				$("#btnSearch").on('click', function () {
					$("#mapLoaging").show();
					deviceMap();
					$("#deviceDetail").hide();
				})

			});

			// 맵에 장비코드 보내기
			function deviceMap() {
				if ($("#intervaltime").val().trim() === '') {
					alertCaution("조회할 날짜를 선택해주세요");
					return false;
				}

				var params = {
					emNumber:$('#s_emNumber').val(),
					emType:$('#s_emType').val(),
					emCountry:$('#s_emCountry').val(),
					emLocation:$('#s_emLocation').val(),
				};

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

				$.ajax({
					url:'/api/dashboard/deviceInfoList',
					type : 'post',
					data : params,
					cache:false,
					error:function(request){
						ajaxErrorMsg(request);
					},
					success: function(res){
						var pushValue = [];
						for(var i=0; i<res.data.deviceInfoListDtos.length; i++){
							if(res.data.deviceInfoListDtos[i]["emState"]!=="없음") {
								pushValue.push(nvl(res.data.deviceInfoListDtos[i]["emNumber"], "확 인 불 가"));
							}
						}
						MapChartDeviceId(pushValue);
					}
				});
			}

			// 장비정보 보내기
			function MapChartDeviceId(pushValue) {
				// console.log("pushValue : "+pushValue);

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });
				var deviceIds = [];
				for (var i=0; i<pushValue.length; i++){
					deviceIds.push(pushValue[i]);
				}
				var itemJson = {};
				itemJson.deviceids = deviceIds;
				var devicestr = JSON.stringify(itemJson);
				var params = {
					deviceids:devicestr
				};
				$.ajax({
					url: '/api/dashboard/detailMapDataGraph',
					type: 'post',
					data : params,
					cache: false,
					error: function (request) {
						ajaxErrorMsg(request);
					},
					success: function (res) {
						if (!Ajax.checkResult(res)) {
							return;
						}
						// 맵에 장치보기
						mapDeviceId(res.data.deviceIdNames,res.data.map_data_columns,res.data.bar_data_columns,res.data.statusDatas,
								res.data.temp_brd,res.data.batt_voltage,res.data.solar_current,res.data.solar_voltage,res.data.rsrp,res.data.frontDoor_sol,res.data.inputDoor,res.data.s_fire,res.data.s_stink);

						$("#mapLoaging").hide();
					}
				});
			}

			// 장비상태정보 리스트 보내기
			function mapDeviceId(deviceId,mapGps,level,status,temp_brd,batt_voltage,solar_current,solar_voltage,rsrp,frontDoor_sol,inputDoor,s_fire,s_stink) {
				var locations = mapGps;

				var map;
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 37.14450, lng: 127.03312},
					zoom: 8,
					mapTypeControl: false,
					streetViewControl: false
				});

				var marker, i;

				var iconSrc = [];

				iconSrc['정상'] = "/assets/images/marker.png";
				iconSrc['주의'] = "/assets/images/marker--caution.png";
				iconSrc['심각'] = "/assets/images/marker--severe.png";

				var infowindow = new google.maps.InfoWindow();

				var bounds = new google.maps.LatLngBounds();

				for (i = 0; i < mapGps.length; i++) {
					if(mapGps[i][1]===0 || mapGps[i][2]===0){
						continue;
					}
					marker = new google.maps.Marker({
						position: new google.maps.LatLng(mapGps[i][1], mapGps[i][2]),
						map: map,
						icon: iconSrc[locations[i][3]]
					});

					bounds.extend(marker.position);

					google.maps.event.addListener(marker, 'click', (function(marker, i) {
						var content = '<div class="iw-container" id="iw-container">' +
								'<h2>' + (mapGps[i][0]) + '</h2>' +
								'<dl>' +
								'<dt>' +'상태 : '+status[i]+'</dt>' +
								'<dd>' +'배출량 : '+level[i+1]+'%'+'</dd>' +
								'</dl>' +
								'</div>';
						return function() {
							infowindow.setContent(content);
							infowindow.open(map, marker);
							$("#deviceDetail").show();

							deviceDetail(deviceId[i],level[i+1],status[i],temp_brd[i],batt_voltage[i],solar_current[i],solar_voltage[i],rsrp[i],mapGps[i][1],mapGps[i][2],frontDoor_sol[i],inputDoor[i],s_fire[i],s_stink[i]);

							if (marker.getAnimation() != null) {
								marker.setAnimation(null);
							} else {
								marker.setAnimation(google.maps.Animation.BOUNCE);
								setTimeout(function(){
									marker.setAnimation(null);
								},1500);
							}

						}
					})(marker, i));
				}
				map.fitBounds(bounds);
			}

			// 장치리스트 출력
			function deviceDetail(pushValue,level,state,temp_brd,batt_voltage,solar_current,solar_voltage,rsrp,gps_la,gps_lo,frontDoor_sol,inputDoor,s_fire,s_stink) {
				var $deviceDetail = $('#deviceDetail');
				console.log("pushValue : "+pushValue);

				var params = {
					pushValue:pushValue,
				};

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

				$.ajax({
					url:'/api/dashboard/deviceDetail',
					type : 'post',
					data : params,
					cache:false,
					error:function(request){
						ajaxErrorMsg(request);
					},
					success: function(res){

						var html = '';

						// console.log("deviceOnOffstatus : "+res.data.deviceOnOffstatus);
						// console.log("deviceOnOffTime : "+res.data.deviceOnOffTime);
						var devicetime;
						if(res.data.deviceOnOffTime!=="") {
							var deviceOnOffTimeStamp = new Date(res.data.deviceOnOffTime);
							var deviceOnOffYear = deviceOnOffTimeStamp.getFullYear();
							var deviceOnOffMonth = Number(deviceOnOffTimeStamp.getMonth() + 1);
							if (deviceOnOffMonth < 10) {
								deviceOnOffMonth = "0"+deviceOnOffMonth
							}
							var deviceOnOffDate = deviceOnOffTimeStamp.getDate();
							if (deviceOnOffDate < 10) {
								deviceOnOffDate = "0" + deviceOnOffDate
							}
							var deviceOnOffHour = deviceOnOffTimeStamp.getHours();
							if (deviceOnOffHour < 10) {
								deviceOnOffHour = "0" + deviceOnOffHour
							}
							var deviceOnOffMinute = deviceOnOffTimeStamp.getMinutes();
							if (deviceOnOffMinute < 10) {
								deviceOnOffMinute = "0" + deviceOnOffMinute
							}
							var deviceOnOffSecond = deviceOnOffTimeStamp.getSeconds();
							if (deviceOnOffSecond < 10) {
								deviceOnOffSecond = "0" + deviceOnOffSecond
							}
							devicetime = deviceOnOffYear + '-' + deviceOnOffMonth + '-' + deviceOnOffDate + ' ' + deviceOnOffHour + ':' + deviceOnOffMinute + ':' + deviceOnOffSecond;
						}else{
							devicetime="";
						}

						var baseurl = res.data.awss3url; //aws경로 URL
						var emInstallDate = res.data.deviceDetailList.emInstallDate;

						var installdate = emInstallDate.substring(0,4)+"년 "+emInstallDate.substring(4,6)+"월 "+emInstallDate.substring(6,8)+"일"; // 설치일자 가공

						var today = new Date();
						var dateObj = new Date(emInstallDate.substring(0,4),Number(emInstallDate.substring(4,6))-1,emInstallDate.substring(6,8));
						date1 = parseInt(today.getTime()/1000);
						date2 = parseInt(dateObj.getTime()/1000);
						var timeDifference = date1 - date2;
						var timeDifferenceInHours = timeDifference / 60 / 60;
						var operationDay = timeDifferenceInHours  / 24; // 운영일 가공

						html += '<div class="equipment__section">';

						if(res.data.deviceDetailList.emType!=="iTainer") {
							html += '<div class="equipment__signal">';
							if (res.data.deviceOnOffstatus === true) {
								if (rsrp !== null) {
									if (rsrp < -120) {
										html += '<img src="/assets/images/icon__wifi-0.png" alt="신호강도" />';
									} else if (rsrp < -115) {
										html += '<img src="/assets/images/icon__wifi-1.png" alt="신호강도" />';
									} else if (rsrp < -109) {
										html += '<img src="/assets/images/icon__wifi-2.png" alt="신호강도" />';
									} else if (rsrp < -103) {
										html += '<img src="/assets/images/icon__wifi-3.png" alt="신호강도" />';
									} else {
										html += '<img src="/assets/images/icon__wifi-4.png" alt="신호강도" />';
									}
								} else {
									html += '<img src="/assets/images/icon__wifi-off.png" alt="신호강도" />';
								}
							} else {
								html += '<img src="/assets/images/icon__wifi-off.png" alt="신호강도" />';
							}
							html += '</div>';
						}
						html += '<div id="stateLoading" class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						if(state==="정상"){
							html += '<span class="equipment__stat normal">'+'정상'+'</span>';
							if(res.data.deviceOnOffstatus===true){
								html += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html += '<div class="equipment__img">';
							html += '<img alt="이미지" src="'+baseurl+res.data.deviceDetailList.mdId.mdFileid.filePath+'/s_'+res.data.deviceDetailList.mdId.mdFileid.saveFileName+'" />';
							if(res.data.deviceOnOffstatus===false && devicetime!==""){
								html += '<span>'+'최종종료일시 : '+devicetime+'</span>';
							}else if(res.data.deviceOnOffstatus===false && devicetime===""){
								html += '<span>'+'접속이력없음'+'</span>';
							}
							html += '</div>';
						}else if(state==="주의"){
							html += '<span class="equipment__stat caution">'+'주의'+'</span>';
							if(res.data.deviceOnOffstatus===true){
								html += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html += '<div class="equipment__img">';
							html += '<img alt="이미지" src="'+baseurl+res.data.deviceDetailList.mdId.mdFileid.filePath+'/s_'+res.data.deviceDetailList.mdId.mdFileid.saveFileName+'" />';
							if(res.data.deviceOnOffstatus===false && devicetime!==""){
								html += '<span>'+'최종종료일시 : '+devicetime+'</span>';
							}else if(res.data.deviceOnOffstatus===false && devicetime===""){
								html += '<span>'+'접속이력없음'+'</span>';
							}
							html += '</div>';
						}else if(state==="심각"){
							html += '<span class="equipment__stat severe">'+'심각'+'</span>';
							if(res.data.deviceOnOffstatus===true){
								html += '<span class="equipment__connect on">'+'온라인'+'</span>';
							}else{
								html += '<span class="equipment__connect off">'+'오프라인'+'</span>';
							}
							html += '<div class="equipment__img">';
							html += '<img alt="이미지" src="'+baseurl+res.data.deviceDetailList.mdId.mdFileid.filePath+'/s_'+res.data.deviceDetailList.mdId.mdFileid.saveFileName+'" />';
							if(res.data.deviceOnOffstatus===false && devicetime!==""){
								html += '<span>'+'최종종료일시 : '+devicetime+'</span>';
							}else if(res.data.deviceOnOffstatus===false && devicetime===""){
								html += '<span>'+'접속이력없음'+'</span>';
							}
							html += '</div>';
						}else{
							html += '<span class="equipment__stat unknowon">'+'없음'+'</span>';
							html += '<span class="equipment__connect unknowon">'+'알수없음'+'</span>';
							html += '<div class="equipment__img">';
							html += '<img alt="이미지" src="'+baseurl+res.data.deviceDetailList.mdId.mdFileid.filePath+'/s_'+res.data.deviceDetailList.mdId.mdFileid.saveFileName+'" />';
							if(res.data.deviceOnOffstatus===false && devicetime!==""){
								html += '<span>'+'최종종료일시 : '+devicetime+'</span>';
							}else if(res.data.deviceOnOffstatus===false && devicetime===""){
								html += '<span>'+'없는 장비'+'</span>';
							}
							html += '</div>';
						}
						html += '</div>';

						html += '<div class="equipment__section">';
						html += '<div id="deviceLoading" class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						html += '<h4 class="equipment__section-title">장치 상태정보</h4>';
						html += '<ul class="equipment__info">';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'장비 ID : '+'</span>';
						html += '<span id="emNumber" class="equipment__info-value">'+res.data.deviceDetailList.emNumber+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'모델타입 : '+'</span>';
						html += '<span class="equipment__info-value">'+res.data.deviceDetailList.emType+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'모델명 : '+'</span>';
						html += '<span class="equipment__info-value">'+res.data.deviceDetailList.mdId.mdName+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'운영사 : '+'</span>';
						html += '<span class="equipment__info-value">'+res.data.deviceDetailList.company.csOperator+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'국가/지역 : '+'</span>';
						html += '<span class="equipment__info-value">'+res.data.deviceDetailList.emLocationName+'/'+res.data.deviceDetailList.emCountryName+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'설치일자 : '+'</span>';
						html += '<span class="equipment__info-value">'+installdate+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'운영일 : '+'</span>';
						html += '<span class="equipment__info-value">'+parseInt(operationDay)+'일'+'</span>';
						html += '</li>';
						html += '<li class="equipment__info-item">';
						if(res.data.deviceDetailList.emType==="iSolarbin") {
							html += '<input type="button" class="c-button c-button--point" value="모뎀리셋" onclick="modemReset()" />';
						}
						html += '</li>';
						html += '</ul>';
						html += '</div>';

						html += '<div class="equipment__section">';
						html += '<div id="detailLoading" class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						html += '<h4 class="equipment__section-title">상태 상태정보</h4>';
						html += '<ul class="equipment__info">';
						html += '<li class="equipment__info-item">';
						if(res.data.deviceDetailList.emType!=="iTainer") {
							html += '<span class="equipment__info-title">'+'온도 : '+'</span>';
							html += '<span class="equipment__info-value">'+tem(temp_brd,"확 인 불 가")+'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">'+'배출량 : '+'</span>';
							html += '<span class="equipment__info-value">'+lev(level,"확 인 불 가")+'</span>';
							html += '</li>';
							if(batt_voltage!=="na"){
								html += '<li class="equipment__info-item">';
								html += '<span class="equipment__info-title">' + '배터리전압 : ' + '</span>';
								html += '<span class="equipment__info-value">'+batt_voltage+'V'+'</span>';
								html += '</li>';
							}else{
								html += '<li class="equipment__info-item">';
								html += '<span class="equipment__info-title">' + '배터리전압 : ' + '</span>';
								html += '<span class="equipment__info-value">' + 'na' + '</span>';
								html += '</li>';
							}
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '태양광판넬 전류 : ' + '</span>';
							html += '<span class="equipment__info-value">' + solar_current + 'A' + '</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '태양광판넬 전압 : ' + '</span>';
							html += '<span class="equipment__info-value">' + solar_voltage + 'V' + '</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '전면도어 : ' + '</span>';
							html += '<span class="equipment__info-value">' + frontDoor_sol +'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '투입구 : ' + '</span>';
							html += '<span class="equipment__info-value">' + inputDoor +'</span>';
							html += '</li>';
						}else{
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '온도 : ' + '</span>';
							html += '<span class="equipment__info-value">'+tem(temp_brd,"확 인 불 가")+'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '배출량 : ' + '</span>';
							html += '<span class="equipment__info-value">'+lev(level,"확 인 불 가")+'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '배출무게(%) : ' + '</span>';
							html += '<span class="equipment__info-value">'+lev(batt_voltage,"확 인 불 가")+'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '배출무게(g) : ' + '</span>';
							html += '<span class="equipment__info-value">'+grm(solar_current,"확 인 불 가")+'</span>';
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '사용언어 : ' + '</span>';
							if(solar_voltage==="ko"){
								html += '<span class="equipment__info-value">' + "한국어" +'</span>';
							}else if(solar_voltage==="en"){
								html += '<span class="equipment__info-value">' + "영어" +'</span>';
							}else{
								html += '<span class="equipment__info-value">' + "중국어" +'</span>';
							}
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '화재 : ' + '</span>';
							if(s_fire==="normal"){
								html += '<span style="color:#00ac23" class="equipment__info-value">' + "정상" +'</span>';
							}else{
								html += '<span style="color:#ff2020" class="equipment__info-value">' + "심각" +'</span>';
							}
							html += '</li>';
							html += '<li class="equipment__info-item">';
							html += '<span class="equipment__info-title">' + '악취 : ' + '</span>';
							if(s_stink==="normal"){
								html += '<span style="color:#00ac23" class="equipment__info-value">' + "정상" +'</span>';
							}else{
								html += '<span style="color:#ff2020" class="equipment__info-value">' + "심각" +'</span>';
							}
							html += '</li>';
						}
						html += '<li class="equipment__info-item">';
						html += '<span class="equipment__info-title">'+'GPS : '+'</span>';
						html += '<span class="equipment__info-value">'+gps_la+'/'+gps_lo+'</span>';
						html += '</li>';
						html += '</ul>';
						html += '</div>';

						html += '<div class="equipment__section">';
						html += '<div id="timechartLoading" class="c-loader">';
						html += '<div class="c-loader__active c-loader__active--ring"></div>';
						html += '</div>';
						html += '<input type="hidden" id="intervaltime" value ="24" readonly="readonly" />';
						html += '<canvas id="timeStampChart" style="width: 100%;height: 220px;"></canvas>';
						html += '<span style="display: none;" class="data--non" id='+'spanText'+'></span>';
						html += '</div>';

						$deviceDetail.html(html);
						if(res.data.deviceDetailList.emType!=="iTainer") {
							timeStamp(pushValue,"ISOL");
						}else{
							timeStamp(pushValue,"ITAI");
						}
					}
				});
			}

			// iSolarbin용 모뎀리셋버튼
			function modemReset() {
				// console.log("$emNumber : "+$("#emNumber"+idx).text());
				var $emNumber = $("#emNumber").text();
				timestamp = + new Date();

				if ($emNumber === null) {
					alertCaution("장비코드가 존재하지 않습니다.");
					return false;
				}

				var params = {
					emNumber:$emNumber,
					timestamp:timestamp,
				};

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

				$.ajax({
					url:'/api/dashboard/modemReset',
					data : params,
					type : 'post',
					cache:false,
					error:function(request){
						ajaxErrorMsg(request);
					},
					success: function(){
						alertSuccess("모뎀리셋완료");
					}
				});
			}

			// 타임스탬프 그래프함수
			function timeStamp(pushValue,emType){

				var params = {
					deviceid:pushValue,
					intervaltime:$('#intervaltime').val()
				};

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader(header, token); });

				$.ajax({
					url:'/api/dashboard/devicehitory',
					type : 'post',
					data : params,
					cache:false,
					error:function(request){
						ajaxErrorMsg(request);
					},
					success: function(res) {
						statuscode = res.data.statusCode;
						if (statuscode === 200) {
							var temp_brd = []; //온도
							var level = []; //배출량
							var batt_voltage = []; //배터리잔량
							var testTimeStamp = [];
							$.each(res.data.datarow1, function (key, value) {
								testTimeStamp.push(parseInt(value.timestamp));
								if(emType==="ITAI") {
									if (value.s_tmp2 === "na") {
										temp_brd.push(0);
									} else {
										temp_brd.push(value.s_tmp2);
									}
									if (value.actuator_level === "na") {
										level.push(0);
									} else {
										level.push(value.actuator_level);
									}
									if (value.dis_info_level === "na") {
										batt_voltage.push(0);
									} else {
										batt_voltage.push(value.dis_info_level);
									}
								}else{
									if (value.temp_brd === "na") {
										temp_brd.push(0);
									} else {
										temp_brd.push(value.temp_brd);
									}
									if (value.level === "na") {
										level.push(0);
									} else {
										level.push(value.level);
									}
									if (value.batt_voltage === "na") {
										batt_voltage.push(0);
									} else {
										batt_voltage.push(value.batt_voltage);
									}
								}
							});

							var ctx;
							var nowDate;
							var min_milliseconds;
							var barChartData;
							var $days;
							if (temp_brd.length === 0 && level.length === 0 && batt_voltage.length === 0) {
								spantext = $('#spanText');
								spantext.text("데이터가 존재하지 않습니다.")

								temp_brd.push(0);
								level.push(0);
								batt_voltage.push(0);
								$days = $("#intervaltime").val(); // 기간선택 시간
								ctx = document.getElementById('timeStampChart');

								nowDate = new Date();
								// 라벨 최대값 구하기 (현재날짜)
								max_milliseconds = nowDate.getTime();
								// 라벨 최소값 구하기
								min_milliseconds = nowDate.setHours(nowDate.getHours() - $days);

								if(emType==="ITAI") {
									barChartData = {
										labels: testTimeStamp,
										datasets: [{
											type: 'line',
											label: '온도(℃)',
											yAxisID: 'y',
											backgroundColor: "#e35f5f",
											borderWidth: 2,
											borderColor: "#e35f5f",
											data: temp_brd,
											fill: false
										}, {
											type: 'line',
											label: '배출량(%)',
											yAxisID: 'x',
											backgroundColor: "#48ae63",
											borderWidth: 2,
											borderColor: "#48ae63",
											data: level,
											fill: false
										}, {
											type: 'line',
											label: '배출무게(%)',
											yAxisID: 'x',
											backgroundColor: "#0effbb",
											borderWidth: 2,
											borderColor: "#0effbb",
											data: batt_voltage,
											fill: false
										}]
									}
								}else{
									barChartData = {
										labels: testTimeStamp,
										datasets: [{
											type: 'line',
											label: '온도(℃)',
											yAxisID: 'y',
											backgroundColor: "#e35f5f",
											borderWidth: 2,
											borderColor: "#e35f5f",
											data: temp_brd,
											fill: false
										}, {
											type: 'line',
											label: '배출량(%)',
											yAxisID: 'x',
											backgroundColor: "#48ae63",
											borderWidth: 2,
											borderColor: "#48ae63",
											data: level,
											fill: false
										}, {
											type: 'line',
											label: '배터리전압(V)',
											yAxisID: 'x',
											backgroundColor: "#ffc600",
											borderWidth: 2,
											borderColor: "#ffc600",
											data: batt_voltage,
											fill: false
										}]
									}
								};


								new Chart(ctx, {
									data: barChartData,
									options: {
										elements: {
											point: {
												radius: 0
											}
										},
										legend: {
											posiont: 'top'
										},
										maintainAspectRatio: false,
										stacked: true,
										tooltips: { //팁(모드설정)
											borderWidth: 3,
											borderColor: 'rgb(118,172,255)',
											caretPadding: 65,
											mode: 'index',
											intersect: false,
											caretSize: 0
										},
										hover: { //점 나오기
											mode: 'index',
											intersect: false
										},
										scales: {
											xAxes: [{
												gridLines: {
													drawOnChartArea: false
												},
												display: false,
												type: 'time',
												time: {
													min: min_milliseconds,
													max: max_milliseconds,
													tooltipFormat: 'YYYY' + '년' + 'MM' + '월' + 'DD' + '일 ' + 'HH:mm:ss:a',
												}
											}],
											yAxes: [{
												ticks: {
													// callback: function(value) {
													// 	return value+'%';
													// },
													max: 100,
													min: 0,
													stepSize: 20
												},
												id: 'x',
												type: 'linear',
												display: true,
												position: 'left'
											}, {
												ticks: {
													// callback: function(value) {
													// 	return value+'℃';
													// },
													max: 10,
													min: 0
												},
												id: 'y',
												type: 'linear',
												display: true,
												position: 'right',
												gridLines: {
													drawOnChartArea: false
												}
											}]
										}
									}
								});
								setTimeout(function () {
									$("#deviceLoading").hide();
									$("#stateLoading").hide();
									$("#detailLoading").hide();
									$("#timechartLoading").hide();
									spantext.css('display','block');
								}, 1000);
							} else {
								$days = $("#intervaltime").val(); // 기간선택 시간

								// 온도최대값,최소값 계산(y축그래프)
								temp_brd_Max = Math.max.apply(0, temp_brd); // 온도최대값
								temp_brd_Min = Math.min.apply(0, temp_brd); // 온도최소값

								tempMax = (temp_brd_Max + 15).toFixed(0);
								tempMin = (temp_brd_Min - 15).toFixed(0);

								if(tempMax/5!==0){
									tempMaxsub = tempMax.substring(1,2);
									tempBrdMax = parseInt(tempMax)-parseInt(tempMaxsub);
								}else{
									tempBrdMax = tempMap;
								}

								if (tempMin / 5 !== 0) {
									if (-10 < tempMin < 0) {
										tempMinsub = tempMin.substring(1, 2);
										tempBrdMin = parseInt(tempMin) + parseInt(tempMinsub);
									} else if (tempMin < -10) {
										tempMinsub = tempMin.substring(2, 3);
										tempBrdMin = parseInt(tempMin) + parseInt(tempMinsub);
									} else if (tempMin > 10) {
										tempMinsub = tempMin.substring(1, 2);
										tempBrdMin = parseInt(tempMin) - parseInt(tempMinsub);
									} else {
										tempBrdMin = 0;
									}
								} else {
									tempBrdMin = 0;
								}

								ctx = document.getElementById('timeStampChart');

								nowDate = new Date();

								// 라벨 최대값 구하기 (현재날짜)
								max_milliseconds = nowDate.getTime();
								// 라벨 최소값 구하기
								min_milliseconds = nowDate.setHours(nowDate.getHours() - $days);

								if(emType==="ITAI") {
									barChartData = {
										labels: testTimeStamp,
										datasets: [{
											type: 'line',
											label: '온도(℃)',
											yAxisID: 'y',
											backgroundColor: "#e35f5f",
											borderWidth: 2,
											borderColor: "#e35f5f",
											data: temp_brd,
											fill: false
										}, {
											type: 'line',
											label: '배출량(%)',
											yAxisID: 'x',
											backgroundColor: "#48ae63",
											borderWidth: 2,
											borderColor: "#48ae63",
											data: level,
											fill: false
										}, {
											type: 'line',
											label: '배출무게(%)',
											yAxisID: 'x',
											backgroundColor: "#0effbb",
											borderWidth: 2,
											borderColor: "#0effbb",
											data: batt_voltage,
											fill: false
										}]
									}
								}else{
									barChartData = {
										labels: testTimeStamp,
										datasets: [{
											type: 'line',
											label: '온도(℃)',
											yAxisID: 'y',
											backgroundColor: "#e35f5f",
											borderWidth: 2,
											borderColor: "#e35f5f",
											data: temp_brd,
											fill: false
										}, {
											type: 'line',
											label: '배출량(%)',
											yAxisID: 'x',
											backgroundColor: "#48ae63",
											borderWidth: 2,
											borderColor: "#48ae63",
											data: level,
											fill: false
										}, {
											type: 'line',
											label: '배터리전압(V)',
											yAxisID: 'x',
											backgroundColor: "#ffc600",
											borderWidth: 2,
											borderColor: "#ffc600",
											data: batt_voltage,
											fill: false
										}]
									}
								};

								new Chart(ctx, {
									data: barChartData,
									options: {
										elements: {
											point: {
												radius: 0
											}
										},
										legend: {
											posiont: 'top'
										},
										maintainAspectRatio: false,
										stacked: true,
										tooltips: { //팁(모드설정)
											borderWidth: 3,
											borderColor: 'rgb(118,172,255)',
											caretPadding: 65,
											mode: 'index',
											intersect: false,
											caretSize: 0
										},
										hover: { //점 나오기
											mode: 'index',
											intersect: false
										},
										scales: {
											xAxes: [{
												gridLines: {
													drawOnChartArea: false
												},
												display: false,
												type: 'time',
												time: {
													min: min_milliseconds,
													max: max_milliseconds,
													tooltipFormat: 'YYYY' + '년' + 'MM' + '월' + 'DD' + '일 ' + 'HH:mm:ss:a',
												}
											}],
											yAxes: [{
												ticks: {
													// callback: function(value) {
													// 	return value+'%';
													// },
													max: 100,
													min: 0,
													stepSize: 20
												},
												id: 'x',
												type: 'linear',
												display: true,
												position: 'left'
											}, {
												ticks: {
													// callback: function(value) {
													// 	return value+'℃';
													// },
													max: tempBrdMax,
													min: tempBrdMin
												},
												id: 'y',
												type: 'linear',
												display: true,
												position: 'right',
												gridLines: {
													drawOnChartArea: false
												}
											}]
										}
									}
								});
							}
							setTimeout(function () {
								$("#deviceLoading").hide();
								$("#stateLoading").hide();
								$("#detailLoading").hide();
								$("#timechartLoading").hide();
							}, 1000);
						}
					}
				});
			}

			// 기간선택에 따라 보내는시간 변경하는 함수
			function intervaltimeChange(text) {
				if (text === "1Hours") {
					$("#intervaltime").val("1");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				}else if (text === "3Hours") {
					$("#intervaltime").val("3");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				}else if (text === "24Hours") {
					$("#intervaltime").val("24");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				} else if (text === "7Days") {
					$("#intervaltime").val("168");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				} else if (text === "1Month") {
					$("#intervaltime").val("720");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				} else if (text === "6Month") {
					$("#intervaltime").val("4380");
					$("#fromTo").hide();
					$("#dateFrom").val("");
					$("#dateTo").val("");
				} else if (text === "FromTo") {
					$("#intervaltime").val("");
					$("#fromTo").show();
				}
			}

			// 사용자정의 시간구하기 (날짜선택에따른 시간)
			function intervaltimeDate(date) {
				// console.log("date : " + date); 받아온날짜
				var today = new Date();
				var year = today.getFullYear();
				var month = today.getMonth()+1;
				var day = today.getDate();
				if(month < 10){
					month = "0"+month;
				}
				if(day < 10){
					day = "0"+day;
				}
				var todayData = year+"-"+month+"-"+day;
				$("#dateTo").val(todayData);

				var dateObj = new Date(date);

				if (today<dateObj) {
					alertCaution("현재 날짜보다 앞선 날짜는 <BR> 선택할 수 없습니다.");
					$("#intervaltime").val("");
					$("#dateFrom").val("");
					$("#dateTo").val("");
					return false;
				}

				// console.log("today : " + today); // 오늘날짜
				// console.log("dateObj : " + dateObj); // 사용자정의 날짜
				var hours = parseInt(Math.abs(today - dateObj) / 36e5); // 36e5는 60 * 60 * 1000의 과학 표기법으로, 밀리 초 차이를 시간으로 환산하여 나눔.
				// console.log("hours : " + hours); // 정해진시간
				$("#intervaltime").val(hours);
			}

			// 국가,지역검색
			function LocationSetting(value) {
				// console.log("value : "+value);

				var params = {
					s_emCountry:value
				};

				var $s_emLocation = $("#s_emLocation");

				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$(document).ajaxSend(function (e, xhr) { xhr.setRequestHeader(header, token); });

				$.ajax({
					url: '/api/dashboard/location',
					type: 'post',
					data: params,
					cache: false,
					error:function(request){
						ajaxErrorMsg(request);
					},
					success: function (res) {
						if (!Ajax.checkResult(res)) {
							return;
						}

						var html = '';
						html += '<option value ="">'+'전체'+'</option>';
						$.each(res.data.locationData, function (key, value) {
							if(res.data.locationData!=null) {
								html += '<option value ="' + echoNull2Blank(value.code) + '">' + echoNull2Blank(value.name) + '</option>';
							}
						});
						$s_emLocation.html(html);
					}
				});
			}

		</script>
	</head>
	  
<div layout:fragment="content" class="contents-body">
	<div class="page">
		<div class="page-title">
			<div class="page-title__left">
				<h2>위치기반</h2>
			</div>
		</div>
		<div class="dashboard">
			<div class="dashboard__row">
				<div class="panel">
					<div class="panel__inner">
						<div class="panel__body panel__body--height-auto">
							<div class="panel__console">
								<div class="panel__console panel__console--left">
									<div class="c-btn-group">
										<h5 class="c-btn-group__title">기간 선택</h5>
										<div class="c-btn-group__list">
											<button onclick="intervaltimeChange(this.value)" id="removehour" value="1Hours" class="c-btn-group__button">1Hours</button>
											<button onclick="intervaltimeChange(this.value)" id="starthour" value="3Hours" class="c-btn-group__button">3Hours</button>
											<button onclick="intervaltimeChange(this.value)" value="24Hours" class="c-btn-group__button">24Hours</button>
											<button onclick="intervaltimeChange(this.value)" value="7Days" class="c-btn-group__button">7Days</button>
											<button onclick="intervaltimeChange(this.value)" value="1Month" class="c-btn-group__button">1Month</button>
											<button onclick="intervaltimeChange(this.value)" value="6Month" class="c-btn-group__button">1Year</button>
											<button onclick="intervaltimeChange(this.value)" value="FromTo" class="c-btn-group__button">FromTo</button>
										</div>
										<input type="hidden" id="intervaltime" value ="" readonly="readonly" />
									</div>
								</div>
								<div class="panel__console panel__console--right">
									<div class="c-float">
										<div class="c-float__item" id="fromTo" style="display: none">
											<div class="c-date-group" >
												<div class="c-date">
													<label for="dateFrom" class="c-date__label">from</label>
													<input type="text" class="c-text__input" id="dateFrom" placeholder="연 - 월 - 일" onchange="intervaltimeDate(this.value)" />
												</div>
												<div class="c-date">
													<label for="dateTo" class="c-date__label">today</label>
													<input type="text" class="c-text__input" id="dateTo" placeholder="연 - 월 - 일" readonly="readonly" />
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="c-float c-float--flex">
								<div class="c-float__item">
									<div class="c-text">
										<label for="s_emNumber" class="c-text__label">장비번호</label>
										<input id="s_emNumber" type="text" class="c-text__input" />
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emType" class="c-select__label">장비 타입</label>
										<select id="s_emType" class="c-select__input">
											<option value="">전체</option>
											<option th:each ="equipdType : ${equipdTypes}"
													th:value="${equipdType.code}"
													th:text="${equipdType.name}"
											></option>
										</select>
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emCountry" class="c-select__label">국가</label>
										<select id="s_emCountry" class="c-select__input" onchange="LocationSetting(this.value)">
											<option value="">전체</option>
											<option th:each ="equipdCountry : ${equipdCountrys}"
													th:value="${equipdCountry.code}"
													th:text="${equipdCountry.name}">
											</option>
										</select>
									</div>
								</div>
								<div class="c-float__item">
									<div class="c-select">
										<label for="s_emLocation" class="c-select__label">지역</label>
										<select id="s_emLocation" class="c-select__input">
										</select>
									</div>
								</div>
								<div class="c-float__item c-float__item--flex--auto" style="padding-top: 15px;">
									<button id="btnSearch" class="c-button c-button--point">조회</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="dashboard__row">
				<div class="panel">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">Location</h4>
						</div>
						<div class="panel__body panel__body--height-auto">
							<div id="mapLoaging" class="c-loader">
								<div class="c-loader__active c-loader__active--ring"></div>
							</div>
							<div class="map map--big" id="map"></div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="dashboard__row">
				<div class="panel">
					<div class="panel__inner">
						<div class="panel__header">
							<h4 class="panel__title">기기</h4>
						</div>
						<div class="panel__body panel__body--height-auto panel__body--non-padding">
							<ul id="deviceDetail" class="c-list equipment">
							</ul>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>
</html>