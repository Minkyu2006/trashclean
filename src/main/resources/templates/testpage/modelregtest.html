<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate ="~{layout/default}">
<head>
	<script type="text/javascript">

		$(function(){

			$("#mdSaveBtn").on('click',function(){
				save();
			});

			$("#btnNew").on('click',function(){
				init();
			});

			$("#btnSearch").on('click',function(){
				list(1);
			});

			$("#btnReset").on('click',function(){
				reset();
			});

			$("#btnDel").on('click',function(){
				del();
			});

		})

		// 조건초기화
		function reset() {
			$("#s_mdName").val('');
			$("#s_mdType").val('');
			$("#s_mdRemark").val('');
		}

		// 모델신규작성
		function init(){
			$("#mdNumber").val('');
			$("#mdName").val('');
			$("#mdType").val('52');
			$("#mdSubname").val('');
			$("#mdRemark").val('');
		}

		// 모델 등록
		function save() {
			if ($("#mdName").val().trim() == '') {
				alertCaution("모델명을 작성해주세요.");
				return false;
			}

			var formData = new FormData(document.getElementById('mdreg'));

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr, options) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/model/reg',
				type : 'post',
				data : formData,
				processData : false,
				contentType : false,
				enctype: 'multipart/form-data',
				cache:false,
				error:function(request,status,error){
					ajaxErrorMsg(request);
				},
				success: function(res){
					if (!Ajax.checkResult(res)) {
						return;
					}
					alertSuccess('저장되었습니다.')
					init();
					list(1);
				}
			});
		}

		// 모델조회
		function list(page){

			page = page - 1;
			if (page < 0) page = 0

			var perPage = 10;
			var perArea = 5;
			var totCnt = 0;

			var $schList = $('#schList');
			var $totalCnt = $('#totalCnt');

			var params = {
				mdName:$('#s_mdName').val(),
				mdType:$('#s_mdType').val(),
				mdRemark:$('#s_mdRemark').val(),
			};

			$schList.empty().append('<tr ><td colspan="9" align = "center">조회 중</td></tr>');
			$totalCnt.text('0');

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr, options) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url:'/api/model/list?size='+ perPage + '&page=' + page,
				type : 'post',
				data : params,
				cache:false,
				error:function(request,status,error){
					ajaxErrorMsg(request);
				},
				success: function(res) {
					totCnt = res.data.total_rows;
					$("#paging1").jqueryPager({pageSize: perPage,
						pageBlock: perArea,
						currentPage: page + 1,
						pageTotal: totCnt,
						clickEvent: 'callList'});
					if (totCnt == 0) {
						$schList.empty().append('<tr class="t-c"><td colspan="9" align="center">조회된 데이터가 없습니다.</td></tr>');
						return;
					}
					$totalCnt.text(totCnt);

					var baseurl = res.data.awss3url;
					console.log("baseurl : "+baseurl)

					var html = '';
					$.each(res.data.datalist, function(key, value){
						// console.log("baseurl : "+nvl(value.awsURL,"확 인 불 가"))
						html += '<tr >';
							html += '<td >'+ nvl(value.mdNumber,"확 인 불 가") +'</td>';
							html += '<td >'+ nvl(value.mdName,"확 인 불 가") +'</td>';
							html += '<td >'+ nvl(value.mdType,"확 인 불 가") +'</td>';
							// html += '   <td><img width="50" src="'+ baseurl+ nvl(value.fileUpload,"확 인 불 가") +'"</img></td>';
							html += '<td >'+ nvl(value.mdFileid,"확 인 불 가") +'</td>';
							//html += '<td >'+"이미지 미리보기"+'</td>';
							html += '<td >'+ nvl(value.mdSubname,"확 인 불 가") +'</td>';
							html += '<td >'+ nvl(value.mdRemark,"확 인 불 가") +'</td>';
						html += '<td ><button class="c-button c-button--point c-button--small" onclick="javascript:modelInfo(\''+nvl(value.id,"확 인 불 가")+'\');">보기</button></td>';
						html += '</tr>';
					});
					$schList.html(html);
				}
			});
		}

		// 모델정보보기
		function modelInfo(id) {

			var params = {
				id:id
			}
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function(e, xhr, options) { xhr.setRequestHeader(header, token); });

			$.ajax({
				url: '/api/model/info',
				type: 'post',
				data: params,
				cache: false,
				error: function (request, status, error) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					$("#mdNumber").val(res.data.iModel.mdNumber);
					$("#mdName").val(res.data.iModel.mdName);
					$("#mdType").val(res.data.iModel.mdTypeId);
					$("#mdSubname").val(res.data.iModel.mdSubname);
					// $("#modelfile").val(res.data.equipment.iModel.csNumber); 이미지 이름?
					$("#mdRemark").val(res.data.iModel.mdRemark);
				}
			});
		}

		//삭제버튼 실행
		function del() {
			if ($("#mdNumber").val().trim() == '') {
				alertCaution("삭제하고자하는 장비를 선택하세요.");
				return false;
			}

			var params = {
				mdNumber: $("#mdNumber").val()
			};

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			$(document).ajaxSend(function (e, xhr) {
				xhr.setRequestHeader(header, token);
			});

			$.ajax({
				url: '/api/model/del',
				type: 'post',
				data: params,
				cache: false,
				error: function (request) {
					ajaxErrorMsg(request);
				},
				success: function (res) {
					if (!Ajax.checkResult(res)) {
						return;
					}
					alertSuccess('장비가 삭제 되었습니다.');
					init();
					list(1);
				}
			})
		}

    </script>
</head>

<div layout:fragment="content" class="contents-body">
	<section class="section">
		<article class="article">
			<h2 class="article__heading">모델 조회</h2>
			<div class="l-float-heading">
				<div class="l-float-heading--left">
					<h4 class="article__head">검색조건<span class="article__head-caption">(수정하려면 조회 후 초기화 버튼을 클릭하세요.)</span></h4>
				</div>
				<div class="l-float-heading--right"><button class="c-button c-button--small" id="btnReset">조건 초기화</button></div>
			</div>
			<table class="c-table">
				<colgroup>
					<col style="width: 80px;" />
					<col />
					<col style="width: 80px;" />
					<col />
					<col style="width: 80px;" />
					<col />
					<col style="width: 62px;" />
				</colgroup>
				<tr>
					<th>모델명</th>
					<td>
						<div class="c-text">
							<input type="text" id="s_mdName" class="c-text__input" />
						</div>
					</td>
					<th>모델 타입</th>
					<td>
						<div class="c-select">
							<select id="s_mdType" class="c-select__input">
								<option value="">전체</option>
								<option th:each ="modelType : ${modelTypes}"
										th:value="${modelType.code}"
										th:text="${modelType.name}"
								></option>
							</select>
						</div>
					</td>
					<th>특이사항</th>
					<td>
						<div class="c-text">
							<input type="text" id="s_mdRemark" class="c-text__input" />
						</div>
					</td>
					<td>
						<button class="c-button c-button--point" id="btnSearch">조회</button>
					</td>
				</tr>
			</table>
		</article>
		<article class="article">
			<table class="c-table">
				<colgroup>
					<col />
					<col />
					<col />
					<col  />
					<col />
					<col />
					<col style="width: 90px;"/>
				</colgroup>
				<thead>
				<tr>
					<th>모델 번호</th>
					<th>모델명</th>
					<th>모델 타입</th>
					<th>이미지</th>
					<th>모델명(약칭)</th>
					<th>특이사항</th>
					<th></th>
				</tr>
				</thead>
				<tbody id="schList">

				</tbody>
			</table>

			<div class="c-pager">
				<div class="c-paging" id="paging1">
				</div>
				<div class="c-paging__total">
					<div class="c-paging__total-group">
						Total
					</div>
					<div class="c-paging__total-group" id="totalCnt">0</div>
				</div>
			</div>
		</article>
	</section>

	<section class="section">
		<article class="article">
			<h2 class="article__heading">모델 등록</h2>
			<form id ="mdreg" enctype="multipart/form-data">
				<table class="c-table">
					<tbody>
					<tr>
						<th>모델 번호</th>
						<td>
							<div class="c-text">
								<input type="text" name="mdNumber" id="mdNumber" class="c-text__input" readonly="readonly" />
							</div>
						</td>
						<th>모델명</th>
						<td>
							<div class="c-text">
								<input type="text" name="mdName" id="mdName" class="c-text__input" />
							</div>
						</td>
					</tr>
					<tr>
						<th>모델 타입</th>
						<td>
							<div class="c-select">
								<select id="mdType" name="mdType" class="c-select__input">
									<option th:each ="modelType : ${modelTypes}"
											th:value="${modelType.id}"
											th:text="${modelType.name}"
									></option>
								</select>
							</div>
						</td>
						<th>이미지업로드</th>
						<td>

<!--							<input type="text" readonly="readonly" class="c-file__input" id="file0" name="file0" />-->
							<div class="c-text">
								<input class="c-button" value="파일선택" type="file" name="file" />
							</div>
<!--							<div class="c-file">-->
<!--								<input type="file" name="file0" id="modelfile"/>-->
<!--							</div>-->
						</td>
					</tr>
					<tr>
						<th>모델명(약칭)</th>
						<td>
							<div class="c-calendar-layout">
								<div class="c-text">
									<input type="text" name="mdSubname" id="mdSubname" class="c-date__input" />
								</div>
							</div>
						</td>
						<th>특이사항</th>
						<td>
							<div class="c-text">
								<input type="text" name="mdRemark" id="mdRemark" class="c-date__input" />
							</div>
						</td>
					</tr>
					</tbody>
				</table>
			</form>
			<div class="c-function">
				<div class="c-function__group c-function__group--right">
					<div class="c-function__item">
						<button class="c-button c-button--point" id="btnNew">신규</button>
					</div>
					<div class="c-function__item">
						<button class="c-button c-button--point" id ="mdSaveBtn">저장</button>
					</div>
					<div class="c-function__item">
						<button class="c-button" id="btnDel">삭제</button>
					</div>
				</div>
			</div>
		</article>
	</section>
	<div id='alertpop'>
	</div>
</div>
</html>
